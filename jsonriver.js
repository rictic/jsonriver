async function*k(i){let e=new p(i);for await(let t of e)yield t}var p=class{input;outputBuffer=[];stack=[0];constructor(e){this.input=new h(e)}async next(){for(;;){let e=this.outputBuffer.length;if(this.tokenizeMore(),!(this.outputBuffer.length>e)){if(this.outputBuffer.length>0){let t=this.outputBuffer;return this.outputBuffer=[],{done:!1,value:t}}if(this.stack.length===0)return await this.input.expectEndOfContent(),{done:!0,value:void 0};await this.input.tryToExpandBuffer()}}}tokenizeMore(){let e=this.stack[this.stack.length-1];switch(e){case 0:this.tokenizeValue();break;case 1:this.tokenizeString();break;case 2:this.tokenizeArrayStart();break;case 3:this.tokenizeAfterArrayValue();break;case 4:this.tokenizeObjectStart();break;case 5:this.tokenizeAfterObjectKey();break;case 6:this.tokenizeAfterObjectValue();break;case 7:this.tokenizeBeforeObjectKey();break;case void 0:return;default:{let t=e;throw new Error(`Unreachable: ${JSON.stringify(t)}`)}}}tokenizeValue(){if(this.input.skipPastWhitespace(),this.input.tryToTakePrefix("null")){this.outputBuffer.push({type:0,value:void 0}),this.stack.pop();return}if(this.input.tryToTakePrefix("true")){this.outputBuffer.push({type:1,value:!0}),this.stack.pop();return}if(this.input.tryToTakePrefix("false")){this.outputBuffer.push({type:1,value:!1}),this.stack.pop();return}if(this.input.testBuffer(/^[-0123456789]/))if(this.input.bufferComplete){let e=this.input.buffer.match(/^[-+0123456789eE.]+/);if(!e)throw new Error("Invalid number");this.input.buffer=this.input.buffer.slice(e[0].length);let t=JSON.parse(e[0]);this.outputBuffer.push({type:2,value:t}),this.stack.pop(),this.input.moreContentExpected=!0;return}else{let e=this.input.buffer.match(/[^-+0123456789eE.]/);if(!e){this.input.moreContentExpected=!1;return}let t=this.input.buffer.slice(0,e.index);this.input.buffer=this.input.buffer.slice(e.index);let n=JSON.parse(t);this.outputBuffer.push({type:2,value:n}),this.stack.pop();return}if(this.input.tryToTakePrefix('"')){this.stack.pop(),this.stack.push(1),this.outputBuffer.push({type:4,value:void 0}),this.tokenizeString();return}if(this.input.tryToTakePrefix("["))return this.stack.pop(),this.stack.push(2),this.outputBuffer.push({type:7,value:void 0}),this.tokenizeArrayStart();if(this.input.tryToTakePrefix("{"))return this.stack.pop(),this.stack.push(4),this.outputBuffer.push({type:9,value:void 0}),this.tokenizeObjectStart()}tokenizeString(){let e={type:5,value:""},t=n=>{e.value===""&&this.outputBuffer.push(e),e.value+=n};for(;;){let[n,r]=this.input.takeUntil(/["\\]/);if(n.length>0){if(/[\x00-\x1f]/.test(n))throw new Error("Unescaped control character in string");t(n)}else if(!r)return;if(r){if(this.input.buffer.length===0)return;if(this.input.buffer[0]==='"'){if(this.input.buffer=this.input.buffer.slice(1),this.outputBuffer.at(-1)?.type===5&&this.outputBuffer.at(-2)?.type===4){let c=this.outputBuffer.pop();this.outputBuffer.pop(),this.outputBuffer.push({type:3,value:c.value})}else this.outputBuffer.push({type:6,value:void 0});this.stack.pop();return}let s=this.input.buffer[1];if(s===void 0)return;if(s==="u"){if(this.input.buffer.length<6)return;let c=this.input.buffer.slice(2,6);this.input.buffer=this.input.buffer.slice(6),t(JSON.parse(`"\\u${c}"`));continue}else this.input.buffer=this.input.buffer.slice(2);let a;switch(s){case"n":{a=`
`;break}case"r":{a="\r";break}case"t":{a="	";break}case"b":{a="\b";break}case"f":{a="\f";break}case"\\":{a="\\";break}case"/":{a="/";break}case'"':{a='"';break}default:throw new Error("Bad escape in string")}t(a)}}}tokenizeArrayStart(){if(this.input.skipPastWhitespace(),this.input.buffer.length!==0)if(this.input.tryToTakePrefix("]")){this.outputBuffer.push({type:8,value:void 0}),this.stack.pop();return}else this.stack.pop(),this.stack.push(3),this.stack.push(0),this.tokenizeValue()}tokenizeAfterArrayValue(){this.input.skipPastWhitespace();let e=this.input.tryToTake(1);switch(e){case void 0:return;case"]":{this.outputBuffer.push({type:8,value:void 0}),this.stack.pop();return}case",":return this.stack.push(0),this.tokenizeValue();default:throw new Error("Expected , or ], got "+JSON.stringify(e))}}tokenizeObjectStart(){this.input.skipPastWhitespace();let e=this.input.tryToTake(1);switch(e){case void 0:return;case"}":{this.outputBuffer.push({type:10,value:void 0}),this.stack.pop();return}case'"':return this.stack.pop(),this.stack.push(5),this.stack.push(1),this.outputBuffer.push({type:4,value:void 0}),this.tokenizeString();default:throw new Error("Expected start of object key, got "+e)}}tokenizeAfterObjectKey(){this.input.skipPastWhitespace();let e=this.input.tryToTake(1);switch(e){case void 0:return;case":":return this.stack.pop(),this.stack.push(6),this.stack.push(0),this.tokenizeValue();default:throw new Error("Expected colon after object key, got "+e)}}tokenizeAfterObjectValue(){this.input.skipPastWhitespace();let e=this.input.tryToTake(1);switch(e){case void 0:return;case"}":{this.outputBuffer.push({type:10,value:void 0}),this.stack.pop();return}case",":return this.stack.pop(),this.stack.push(7),this.tokenizeBeforeObjectKey();default:throw new Error("Expected , or } after object value, got "+e)}}tokenizeBeforeObjectKey(){this.input.skipPastWhitespace();let e=this.input.tryToTake(1);switch(e){case void 0:return;case'"':return this.stack.pop(),this.stack.push(5),this.stack.push(1),this.outputBuffer.push({type:4,value:void 0}),this.tokenizeString();default:throw new Error("Expected start of object key, got "+e)}}[Symbol.asyncIterator](){return this}};function o(i){switch(i){case 0:return"null";case 1:return"boolean";case 2:return"number";case 3:return"string";case 4:return"string start";case 5:return"string middle";case 6:return"string end";case 7:return"array start";case 8:return"array end";case 9:return"object start";case 10:return"object end"}}var f=class{input;constructor(e){this.input=e}},h=class{buffer="";bufferComplete=!1;moreContentExpected=!0;stream;synchronous=new f(this);constructor(e){this.stream=e[Symbol.asyncIterator]()}async expectEndOfContent(){this.moreContentExpected=!1;let e=()=>{if(this.buffer=this.buffer.trim(),this.buffer.length!==0)throw new Error(`Unexpected trailing content ${JSON.stringify(this.buffer)}`)};for(e();await this.tryToExpandBuffer();)e();e()}async tryToExpandBuffer(){let e=await this.stream.next();if(e.done){if(this.bufferComplete=!0,this.moreContentExpected)throw new Error("Unexpected end of content");return!1}return this.buffer+=e.value,!0}skipPastWhitespace(){let t=/^[ \n\r\t]+/.exec(this.buffer);t&&(this.buffer=this.buffer.slice(t.index+t[0].length))}testBuffer(e){return e.test(this.buffer)}tryToTakePrefix(e){return this.buffer.startsWith(e)?(this.buffer=this.buffer.slice(e.length),!0):!1}tryToTake(e){if(this.buffer.length<e)return;let t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}takeUntil(e){let t=e.exec(this.buffer);if(t){let r=this.buffer.slice(0,t.index);return this.buffer=this.buffer.slice(t.index),[r,!0]}let n=this.buffer;return this.buffer="",[n,!1]}};function d(i){return new l(i).parse()}var l=class{tokenBuffer=[];stateStack=[{type:0,value:void 0}];toplevelValue;inputComplete=!1;tokenStream;constructor(e){this.tokenStream=k(e)}async expandBuffer(){let e=await this.tokenStream.next();if(e.done){this.inputComplete=!0;return}let t=e.value;for(let n=t.length-1;n>=0;n--)this.tokenBuffer.push(t[n])}async*parse(){for(await this.expandBuffer();;){let e=this.progress();if(this.toplevelValue===void 0)throw new Error("Internal error: toplevelValue should not be undefined after at least one call to progress()");if(e&&(yield this.toplevelValue),this.stateStack.length===0)for(;;){if(this.inputComplete&&this.tokenBuffer.length===0)return;let t=this.tokenBuffer.at(-1);if(t!==void 0)throw new Error(`Unexpected trailing content: ${o(t.type)}`);await this.expandBuffer()}await this.expandBuffer()}}progress(){let e=!1;for(;;){let t=this.tokenBuffer.pop();if(t===void 0)break;let n=this.stateStack.at(-1);if(n===void 0)throw new Error("Unexpected trailing input");if(!e)switch(t.type){case void 0:case 6:case 8:case 10:break;case 4:n.type!==3&&(e=!0);break;case 5:this.stateStack.at(-2)?.type!==3&&(e=!0);break;default:e=!0}switch(n.type){case 0:{this.stateStack.pop(),this.toplevelValue=this.progressValue(t);break}case 1:{let r=this.stateStack.at(-2);switch(t.type){case 5:n.value+=t.value;break;case 6:this.stateStack.pop();break;default:throw new Error(`Unexpected ${o(t.type)} token in the middle of string starting ${JSON.stringify(n.value)}`)}let u=n.value;switch(r?.type){case void 0:{this.toplevelValue=u;break}case 2:{let s=r.value;s[s.length-1]=u;break}case 4:{let[s,a]=r.value;a[s]=u,this.stateStack.at(-1)===r&&(this.stateStack.pop(),this.stateStack.push({type:3,value:a}));break}case 3:{this.stateStack.at(-1)===r&&(this.stateStack.pop(),this.stateStack.push({type:4,value:[u,r.value]}));break}default:throw new Error("Unexpected parent state for string: "+r?.type)}break}case 2:{switch(t.type){case 8:this.stateStack.pop();break;default:{let r=this.progressValue(t);n.value.push(r)}}break}case 3:{switch(t.type){case 4:{this.stateStack.push({type:1,value:""});break}case 3:{this.stateStack.pop(),this.stateStack.push({type:4,value:[t.value,n.value]});break}case 10:this.stateStack.pop();break;default:throw new Error(`Unexpected ${o(t.type)} token in the middle of object expecting key`)}break}case 4:{switch(t.type){case 10:this.stateStack.pop();break;default:{let[r,u]=n.value;t.type!==4&&(this.stateStack.pop(),this.stateStack.push({type:3,value:u}));let s=this.progressValue(t);u[r]=s}}break}}}return e}progressValue(e){switch(e.type){case 0:return null;case 1:return e.value;case 2:return e.value;case 3:return e.value;case 4:{let t={type:1,value:""};return this.stateStack.push(t),""}case 7:{let t={type:2,value:[]};return this.stateStack.push(t),t.value}case 9:{let t={type:3,value:{}};return this.stateStack.push(t),t.value}default:throw new Error("Unexpected token type: "+o(e.type))}}};export{d as parse};
/**
 * @license
 * Copyright Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */
