function S(i,t){return new u(i,t)}var g=/^-?(0|[1-9]\d*)(\.\d+)?([eE][+-]?\d+)?$/;function m(i){if(!g.test(i))throw new Error("Invalid number");return Number(i)}var u=class{input;handler;stack=[0];emittedTokens=0;constructor(t,e){this.input=new d(t),this.handler=e}isDone(){return this.stack.length===0&&this.input.length===0}async pump(){let t=this.emittedTokens;for(;;){let e=this.emittedTokens;if(this.tokenizeMore(),this.emittedTokens>e)continue;if(this.emittedTokens>t){this.input.commit();return}if(this.stack.length===0){await this.input.expectEndOfContent(),this.input.commit();return}await this.input.tryToExpandBuffer()}}tokenizeMore(){let t=this.stack[this.stack.length-1];switch(t){case 0:this.tokenizeValue();break;case 1:this.tokenizeString();break;case 2:this.tokenizeArrayStart();break;case 3:this.tokenizeAfterArrayValue();break;case 4:this.tokenizeObjectStart();break;case 5:this.tokenizeAfterObjectKey();break;case 6:this.tokenizeAfterObjectValue();break;case 7:this.tokenizeBeforeObjectKey();break;case void 0:return;default:{let e=t;throw new Error(`Unreachable: ${JSON.stringify(e)}`)}}}tokenizeValue(){if(this.input.skipPastWhitespace(),this.input.tryToTakePrefix("null")){this.handler.handleNull(),this.emittedTokens++,this.stack.pop();return}if(this.input.tryToTakePrefix("true")){this.handler.handleBoolean(!0),this.emittedTokens++,this.stack.pop();return}if(this.input.tryToTakePrefix("false")){this.handler.handleBoolean(!1),this.emittedTokens++,this.stack.pop();return}if(this.input.length>0){let t=this.input.peekCharCode(0);if(t>=48&&t<=57||t===45){let e=0;for(;e<this.input.length;){let r=this.input.peekCharCode(e);if(r>=48&&r<=57||r===45||r===43||r===46||r===101||r===69)e++;else break}if(e===this.input.length&&!this.input.bufferComplete){this.input.moreContentExpected=!1;return}let n=this.input.slice(0,e);this.input.advance(e);let a=m(n);this.handler.handleNumber(a),this.emittedTokens++,this.stack.pop(),this.input.moreContentExpected=!0;return}}if(this.input.tryToTakePrefix('"')){this.stack.pop(),this.stack.push(1),this.handler.handleStringStart(),this.emittedTokens++,this.tokenizeString();return}if(this.input.tryToTakePrefix("["))return this.stack.pop(),this.stack.push(2),this.handler.handleArrayStart(),this.emittedTokens++,this.tokenizeArrayStart();if(this.input.tryToTakePrefix("{"))return this.stack.pop(),this.stack.push(4),this.handler.handleObjectStart(),this.emittedTokens++,this.tokenizeObjectStart()}tokenizeString(){for(;;){let[t,e]=this.input.takeUntilQuoteOrBackslash();if(t.length>0)this.handler.handleStringMiddle(t),this.emittedTokens++;else if(!e)return;if(e){if(this.input.length===0)return;if(this.input.peek(0)==='"'){this.input.advance(1),this.handler.handleStringEnd(),this.emittedTokens++,this.stack.pop();return}let a=this.input.peek(1);if(a===void 0)return;let r;switch(a){case"u":{if(this.input.length<6)return;let c=0;for(let h=2;h<6;h++){let s=this.input.peekCharCode(h),b=s>=48&&s<=57?s-48:s>=65&&s<=70?s-55:s>=97&&s<=102?s-87:-1;if(b===-1)throw new Error("Bad Unicode escape in JSON");c=c<<4|b}this.input.advance(6),this.handler.handleStringMiddle(String.fromCharCode(c)),this.emittedTokens++;continue}case"n":r=`
`;break;case"r":r="\r";break;case"t":r="	";break;case"b":r="\b";break;case"f":r="\f";break;case"\\":r="\\";break;case"/":r="/";break;case'"':r='"';break;default:throw new Error("Bad escape in string")}this.input.advance(2),this.handler.handleStringMiddle(r),this.emittedTokens++}}}tokenizeArrayStart(){if(this.input.skipPastWhitespace(),this.input.length!==0)if(this.input.tryToTakePrefix("]")){this.handler.handleArrayEnd(),this.emittedTokens++,this.stack.pop();return}else this.stack.pop(),this.stack.push(3),this.stack.push(0),this.tokenizeValue()}tokenizeAfterArrayValue(){this.input.skipPastWhitespace();let t=this.input.tryToTakeCharCode();switch(t){case void 0:return;case 93:{this.handler.handleArrayEnd(),this.emittedTokens++,this.stack.pop();return}case 44:return this.stack.push(0),this.tokenizeValue();default:throw new Error("Expected , or ], got "+JSON.stringify(String.fromCharCode(t)))}}tokenizeObjectStart(){this.input.skipPastWhitespace();let t=this.input.tryToTakeCharCode();switch(t){case void 0:return;case 125:{this.handler.handleObjectEnd(),this.emittedTokens++,this.stack.pop();return}case 34:return this.stack.pop(),this.stack.push(5),this.stack.push(1),this.handler.handleStringStart(),this.emittedTokens++,this.tokenizeString();default:throw new Error("Expected start of object key, got "+JSON.stringify(String.fromCharCode(t)))}}tokenizeAfterObjectKey(){this.input.skipPastWhitespace();let t=this.input.tryToTakeCharCode();switch(t){case void 0:return;case 58:return this.stack.pop(),this.stack.push(6),this.stack.push(0),this.tokenizeValue();default:throw new Error("Expected colon after object key, got "+JSON.stringify(String.fromCharCode(t)))}}tokenizeAfterObjectValue(){this.input.skipPastWhitespace();let t=this.input.tryToTakeCharCode();switch(t){case void 0:return;case 125:{this.handler.handleObjectEnd(),this.emittedTokens++,this.stack.pop();return}case 44:return this.stack.pop(),this.stack.push(7),this.tokenizeBeforeObjectKey();default:throw new Error("Expected , or } after object value, got "+JSON.stringify(String.fromCharCode(t)))}}tokenizeBeforeObjectKey(){this.input.skipPastWhitespace();let t=this.input.tryToTakeCharCode();switch(t){case void 0:return;case 34:return this.stack.pop(),this.stack.push(5),this.stack.push(1),this.handler.handleStringStart(),this.emittedTokens++,this.tokenizeString();default:throw new Error("Expected start of object key, got "+JSON.stringify(String.fromCharCode(t)))}}};function o(i){switch(i){case 0:return"null";case 1:return"boolean";case 2:return"number";case 3:return"string start";case 4:return"string middle";case 5:return"string end";case 6:return"array start";case 7:return"array end";case 8:return"object start";case 9:return"object end"}}var d=class{buffer="";startIndex=0;bufferComplete=!1;moreContentExpected=!0;stream;constructor(t){this.stream=t[Symbol.asyncIterator]()}get length(){return this.buffer.length-this.startIndex}advance(t){this.startIndex+=t}peek(t){return this.buffer[this.startIndex+t]}peekCharCode(t){return this.buffer.charCodeAt(this.startIndex+t)}slice(t,e){return this.buffer.slice(this.startIndex+t,this.startIndex+e)}commit(){this.startIndex>0&&(this.buffer=this.buffer.slice(this.startIndex),this.startIndex=0)}remaining(){return this.buffer.slice(this.startIndex)}async expectEndOfContent(){this.moreContentExpected=!1;let t=()=>{if(this.commit(),this.skipPastWhitespace(),this.length!==0)throw new Error(`Unexpected trailing content ${JSON.stringify(this.remaining())}`)};for(t();await this.tryToExpandBuffer();)t();t()}async tryToExpandBuffer(){let t=await this.stream.next();if(t.done){if(this.bufferComplete=!0,this.moreContentExpected)throw new Error("Unexpected end of content");return!1}return this.buffer+=t.value,!0}skipPastWhitespace(){let t=this.startIndex;for(;t<this.buffer.length;){let e=this.buffer.charCodeAt(t);if(e===32||e===9||e===10||e===13)t++;else break}this.startIndex=t}tryToTakePrefix(t){return this.buffer.startsWith(t,this.startIndex)?(this.startIndex+=t.length,!0):!1}tryToTake(t){if(this.length<t)return;let e=this.buffer.slice(this.startIndex,this.startIndex+t);return this.startIndex+=t,e}tryToTakeCharCode(){if(this.length===0)return;let t=this.buffer.charCodeAt(this.startIndex);return this.startIndex++,t}takeUntilQuoteOrBackslash(){let t=this.buffer,e=this.startIndex;for(;e<t.length;){let a=t.charCodeAt(e);if(a<=31)throw new Error("Unescaped control character in string");if(a===34||a===92){let r=t.slice(this.startIndex,e);return this.startIndex=e,[r,!0]}e++}let n=t.slice(this.startIndex);return this.startIndex=t.length,[n,!1]}};async function*y(i,t){yield*new k(i,t?.completeCallback)}function p(i,t,e){t==="__proto__"?Object.defineProperty(i,t,{value:e,writable:!0,enumerable:!0,configurable:!0}):i[t]=e}var l=Symbol("stateStack"),f=class{[l];constructor(t){this[l]=t}segments(){let t=[];for(let e=0;e<this[l].length;e++){let n=this[l][e];switch(n.type){case 1:case 0:throw new Error("path.segments() was called with unexpected parser state. Called asynchronously?");case 3:n.value[0]!==void 0&&t.push(n.value[0]);continue;case 2:t.push(n.value.length-1);continue;case 4:t.push(n.value[0]);continue;default:{let a=n;throw new Error(`Unexpected state: ${String(a)}`)}}}return t}},k=class{stateStack=[{type:0,value:void 0}];toplevelValue;tokenizer;finished=!1;progressed=!1;completeCallback;completeValueInfo;constructor(t,e){this.completeCallback=e,this.completeValueInfo=new f(this.stateStack),this.tokenizer=S(t,this)}async next(){if(this.finished)return{done:!0,value:void 0};for(;;){if(this.progressed=!1,await this.tokenizer.pump(),this.toplevelValue===void 0)throw new Error("Internal error: toplevelValue should not be undefined after at least one call to pump()");if(this.progressed)return{done:!1,value:this.toplevelValue};if(this.stateStack.length===0)return await this.tokenizer.pump(),this.finished=!0,{done:!0,value:void 0}}}[Symbol.asyncIterator](){return this}handleNull(){this.handleValueToken(0,void 0)}handleBoolean(t){this.handleValueToken(1,t)}handleNumber(t){this.handleValueToken(2,t)}handleStringStart(){let t=this.currentState();switch(!this.progressed&&t.type!==3&&(this.progressed=!0),t.type){case 0:this.stateStack.pop(),this.toplevelValue=this.progressValue(3,void 0);break;case 2:{let e=this.progressValue(3,void 0);t.value.push(e);break}case 3:this.stateStack.push({type:1,value:""});break;case 4:{let[e,n]=t.value,a=this.progressValue(3,void 0);p(n,e,a);break}case 1:throw new Error(`Unexpected ${o(3)} token in the middle of string starting ${JSON.stringify(t.value)}`)}}handleStringMiddle(t){let e=this.currentState();if(this.progressed||this.stateStack[this.stateStack.length-2]?.type!==3&&(this.progressed=!0),e.type!==1)throw new Error(`Unexpected ${o(4)} token in the middle of string starting ${JSON.stringify(e.value)}`);e.value+=t;let n=this.stateStack[this.stateStack.length-2];this.updateStringParent(e.value,n,!1)}handleStringEnd(){let t=this.currentState();if(t.type!==1)throw new Error(`Unexpected ${o(5)} token in the middle of string starting ${JSON.stringify(t.value)}`);this.stateStack.pop();let e=this.stateStack[this.stateStack.length-1];this.updateStringParent(t.value,e,!0)}handleArrayStart(){this.handleValueToken(6,void 0)}handleArrayEnd(){let t=this.currentState();if(t.type!==2)throw new Error(`Unexpected ${o(7)} token`);this.stateStack.pop(),this.completeCallback!==void 0&&this.completeCallback(t.value,this.completeValueInfo)}handleObjectStart(){this.handleValueToken(8,void 0)}handleObjectEnd(){let t=this.currentState();switch(t.type){case 3:case 4:this.stateStack.pop(),this.completeCallback!==void 0&&this.completeCallback(t.value[1],this.completeValueInfo);break;default:throw new Error(`Unexpected ${o(9)} token`)}}currentState(){let t=this.stateStack[this.stateStack.length-1];if(t===void 0)throw new Error("Unexpected trailing input");return t}handleValueToken(t,e){let n=this.currentState();switch(this.progressed||(this.progressed=!0),n.type){case 0:this.stateStack.pop(),this.toplevelValue=this.progressValue(t,e),this.completeCallback!==void 0&&this.stateStack.length===0&&this.completeCallback(this.toplevelValue,this.completeValueInfo);break;case 2:{let a=this.progressValue(t,e);n.value.push(a),this.completeCallback!==void 0&&this.stateStack[this.stateStack.length-1]===n&&this.completeCallback(a,this.completeValueInfo);break}case 4:{let[a,r]=n.value,c=n;t!==3&&(this.stateStack.pop(),c={type:3,value:[a,r]},this.stateStack.push(c));let h=this.progressValue(t,e);p(r,a,h),this.completeCallback!==void 0&&this.stateStack[this.stateStack.length-1]===c&&this.completeCallback(h,this.completeValueInfo);break}case 1:throw new Error(`Unexpected ${o(t)} token in the middle of string starting ${JSON.stringify(n.value)}`);case 3:throw new Error(`Unexpected ${o(t)} token in the middle of object expecting key`)}}updateStringParent(t,e,n){switch(e?.type){case void 0:this.toplevelValue=t,n&&this.completeCallback!==void 0&&this.completeCallback(t,this.completeValueInfo);break;case 2:e.value[e.value.length-1]=t,n&&this.completeCallback!==void 0&&this.completeCallback(t,this.completeValueInfo);break;case 4:{let[a,r]=e.value;p(r,a,t),n&&this.completeCallback!==void 0&&this.completeCallback(t,this.completeValueInfo),this.stateStack[this.stateStack.length-1]===e&&(this.stateStack.pop(),this.stateStack.push({type:3,value:[a,r]}));break}case 3:this.stateStack[this.stateStack.length-1]===e&&(this.stateStack.pop(),this.stateStack.push({type:4,value:[t,e.value[1]]}));break;default:throw new Error("Unexpected parent state for string: "+e?.type)}}progressValue(t,e){switch(t){case 0:return null;case 1:return e;case 2:return e;case 3:{let n={type:1,value:""};return this.stateStack.push(n),""}case 6:{let n={type:2,value:[]};return this.stateStack.push(n),n.value}case 8:{let n={type:3,value:[void 0,{}]};return this.stateStack.push(n),n.value[1]}default:throw new Error("Unexpected token type: "+o(t))}}};export{y as parse};
/**
 * @license
 * Copyright Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */
