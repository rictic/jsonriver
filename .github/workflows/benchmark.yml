name: Node Benchmark

on:
  pull_request:

jobs:
  run-benchmark:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run Node benchmark
        id: benchmark # Give this step an id to access its output later
        run: npm run node-bench

      - name: Comment benchmark output on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' # Only run on PRs
        with:
          github-token: ${{secrets.GITHUB_TOKEN}} # Explicitly pass the token
          script: |
            const rawOutput = `${{ steps.benchmark.outputs.stdout }}`;
            // Further escape backticks for the final markdown code block
            const output = rawOutput.replace(/`/g, '\\`');

            const body = `## Node.js Benchmark Results бенчмарк :rocket:

\`\`\`
${output}
\`\`\`
`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
