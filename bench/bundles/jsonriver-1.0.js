function f(a){return new p(a)}var p=class{input;#t=[];#e=[0];constructor(e){this.input=new h(e)}async next(){for(;;){let e=this.#t.length;if(this.#i(),!(this.#t.length>e)){if(this.#t.length>0){let t=this.#t;return this.#t=[],{done:!1,value:t}}if(this.#e.length===0)return await this.input.expectEndOfContent(),{done:!0,value:void 0};await this.input.tryToExpandBuffer()}}}#i(){let e=this.#e[this.#e.length-1];switch(e){case 0:this.#n();break;case 1:this.#r();break;case 2:this.#a();break;case 3:this.#u();break;case 4:this.#s();break;case 5:this.#c();break;case 6:this.#p();break;case 7:this.#o();break;case void 0:return;default:{let t=e;throw new Error(`Unreachable: ${JSON.stringify(t)}`)}}}#n(){if(this.input.skipPastWhitespace(),this.input.tryToTakePrefix("null")){this.#t.push({type:0,value:void 0}),this.#e.pop();return}if(this.input.tryToTakePrefix("true")){this.#t.push({type:1,value:!0}),this.#e.pop();return}if(this.input.tryToTakePrefix("false")){this.#t.push({type:1,value:!1}),this.#e.pop();return}if(/^[-0123456789]/.test(this.input.buffer))if(this.input.bufferComplete){let e=this.input.buffer.match(/^[-+0123456789eE.]+/);if(!e)throw new Error("Invalid number");this.input.buffer=this.input.buffer.slice(e[0].length);let t=JSON.parse(e[0]);this.#t.push({type:2,value:t}),this.#e.pop(),this.input.moreContentExpected=!0;return}else{let e=this.input.buffer.match(/[^-+0123456789eE.]/);if(!e){this.input.moreContentExpected=!1;return}let t=this.input.buffer.slice(0,e.index);this.input.buffer=this.input.buffer.slice(e.index);let n=JSON.parse(t);this.#t.push({type:2,value:n}),this.#e.pop();return}if(this.input.tryToTakePrefix('"')){this.#e.pop(),this.#e.push(1),this.#t.push({type:4,value:void 0}),this.#r();return}if(this.input.tryToTakePrefix("["))return this.#e.pop(),this.#e.push(2),this.#t.push({type:7,value:void 0}),this.#a();if(this.input.tryToTakePrefix("{"))return this.#e.pop(),this.#e.push(4),this.#t.push({type:9,value:void 0}),this.#s()}#r(){let e={type:5,value:""},t=n=>{e.value===""&&this.#t.push(e),e.value+=n};for(;;){let[n,r]=this.input.takeUntil(/["\\]/);if(n.length>0){if(/[\x00-\x1f]/.test(n))throw new Error("Unescaped control character in string");t(n)}else if(!r)return;if(r){if(this.input.buffer.length===0)return;if(this.input.buffer[0]==='"'){if(this.input.buffer=this.input.buffer.slice(1),this.#t.at(-1)?.type===5&&this.#t.at(-2)?.type===4){let c=this.#t.pop();this.#t.pop(),this.#t.push({type:3,value:c.value})}else this.#t.push({type:6,value:void 0});this.#e.pop();return}let s=this.input.buffer[1];if(s===void 0)return;if(s==="u"){if(this.input.buffer.length<6)return;let c=this.input.buffer.slice(2,6);this.input.buffer=this.input.buffer.slice(6),t(JSON.parse(`"\\u${c}"`));continue}else this.input.buffer=this.input.buffer.slice(2);let i;switch(s){case"n":{i=`
`;break}case"r":{i="\r";break}case"t":{i="	";break}case"b":{i="\b";break}case"f":{i="\f";break}case"\\":{i="\\";break}case"/":{i="/";break}case'"':{i='"';break}default:throw new Error("Bad escape in string")}t(i)}}}#a(){if(this.input.skipPastWhitespace(),this.input.buffer.length!==0)if(this.input.tryToTakePrefix("]")){this.#t.push({type:8,value:void 0}),this.#e.pop();return}else this.#e.pop(),this.#e.push(3),this.#e.push(0),this.#n()}#u(){this.input.skipPastWhitespace();let e=this.input.tryToTake(1);switch(e){case void 0:return;case"]":{this.#t.push({type:8,value:void 0}),this.#e.pop();return}case",":return this.#e.push(0),this.#n();default:throw new Error("Expected , or ], got "+JSON.stringify(e))}}#s(){this.input.skipPastWhitespace();let e=this.input.tryToTake(1);switch(e){case void 0:return;case"}":{this.#t.push({type:10,value:void 0}),this.#e.pop();return}case'"':return this.#e.pop(),this.#e.push(5),this.#e.push(1),this.#t.push({type:4,value:void 0}),this.#r();default:throw new Error("Expected start of object key, got "+e)}}#c(){this.input.skipPastWhitespace();let e=this.input.tryToTake(1);switch(e){case void 0:return;case":":return this.#e.pop(),this.#e.push(6),this.#e.push(0),this.#n();default:throw new Error("Expected colon after object key, got "+e)}}#p(){this.input.skipPastWhitespace();let e=this.input.tryToTake(1);switch(e){case void 0:return;case"}":{this.#t.push({type:10,value:void 0}),this.#e.pop();return}case",":return this.#e.pop(),this.#e.push(7),this.#o();default:throw new Error("Expected , or } after object value, got "+e)}}#o(){this.input.skipPastWhitespace();let e=this.input.tryToTake(1);switch(e){case void 0:return;case'"':return this.#e.pop(),this.#e.push(5),this.#e.push(1),this.#t.push({type:4,value:void 0}),this.#r();default:throw new Error("Expected start of object key, got "+e)}}[Symbol.asyncIterator](){return this}};function o(a){switch(a){case 0:return"null";case 1:return"boolean";case 2:return"number";case 3:return"string";case 4:return"string start";case 5:return"string middle";case 6:return"string end";case 7:return"array start";case 8:return"array end";case 9:return"object start";case 10:return"object end"}}var h=class{buffer="";bufferComplete=!1;moreContentExpected=!0;#t;constructor(e){this.#t=e[Symbol.asyncIterator]()}async expectEndOfContent(){this.moreContentExpected=!1;let e=()=>{if(this.buffer=this.buffer.trim(),this.buffer.length!==0)throw new Error(`Unexpected trailing content ${JSON.stringify(this.buffer)}`)};for(e();await this.tryToExpandBuffer();)e();e()}async tryToExpandBuffer(){let e=await this.#t.next();if(e.done){if(this.bufferComplete=!0,this.moreContentExpected)throw new Error("Unexpected end of content");return!1}return this.buffer+=e.value,!0}skipPastWhitespace(){let t=/^[ \n\r\t]+/.exec(this.buffer);t&&(this.buffer=this.buffer.slice(t.index+t[0].length))}tryToTakePrefix(e){return this.buffer.startsWith(e)?(this.buffer=this.buffer.slice(e.length),!0):!1}tryToTake(e){if(this.buffer.length<e)return;let t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}takeUntil(e){let t=e.exec(this.buffer);if(t){let r=this.buffer.slice(0,t.index);return this.buffer=this.buffer.slice(t.index),[r,!0]}let n=this.buffer;return this.buffer="",[n,!1]}};async function*d(a){yield*new l(a)}var l=class{#t=[];#e=[{type:0,value:void 0}];#i;#n=!1;tokenStream;#r=!1;constructor(e){this.tokenStream=f(e)}async#a(){let e=await this.tokenStream.next();if(e.done){this.#n=!0;return}let t=e.value;for(let n=t.length-1;n>=0;n--)this.#t.push(t[n])}async next(){if(this.#r)return{done:!0,value:void 0};for(;;){await this.#a();let e=this.#u();if(this.#i===void 0)throw new Error("Internal error: toplevelValue should not be undefined after at least one call to progress()");if(e)return{done:!1,value:this.#i};if(this.#e.length===0)for(;;){if(this.#n&&this.#t.length===0)return this.#r=!0,{done:!0,value:void 0};let t=this.#t.at(-1);if(t!==void 0)throw new Error(`Unexpected trailing content: ${o(t.type)}`);await this.#a()}}}[Symbol.asyncIterator](){return this}#u(){let e=!1;for(;;){let t=this.#t.pop();if(t===void 0)break;let n=this.#e.at(-1);if(n===void 0)throw new Error("Unexpected trailing input");if(!e)switch(t.type){case void 0:case 6:case 8:case 10:break;case 4:n.type!==3&&(e=!0);break;case 5:this.#e.at(-2)?.type!==3&&(e=!0);break;default:e=!0}switch(n.type){case 0:{this.#e.pop(),this.#i=this.#s(t);break}case 1:{let r=this.#e.at(-2);switch(t.type){case 5:n.value+=t.value;break;case 6:this.#e.pop();break;default:throw new Error(`Unexpected ${o(t.type)} token in the middle of string starting ${JSON.stringify(n.value)}`)}let u=n.value;switch(r?.type){case void 0:{this.#i=u;break}case 2:{let s=r.value;s[s.length-1]=u;break}case 4:{let[s,i]=r.value;i[s]=u,this.#e.at(-1)===r&&(this.#e.pop(),this.#e.push({type:3,value:i}));break}case 3:{this.#e.at(-1)===r&&(this.#e.pop(),this.#e.push({type:4,value:[u,r.value]}));break}default:throw new Error("Unexpected parent state for string: "+r?.type)}break}case 2:{switch(t.type){case 8:this.#e.pop();break;default:{let r=this.#s(t);n.value.push(r)}}break}case 3:{switch(t.type){case 4:{this.#e.push({type:1,value:""});break}case 3:{this.#e.pop(),this.#e.push({type:4,value:[t.value,n.value]});break}case 10:this.#e.pop();break;default:throw new Error(`Unexpected ${o(t.type)} token in the middle of object expecting key`)}break}case 4:{switch(t.type){case 10:this.#e.pop();break;default:{let[r,u]=n.value;t.type!==4&&(this.#e.pop(),this.#e.push({type:3,value:u}));let s=this.#s(t);u[r]=s}}break}}}return e}#s(e){switch(e.type){case 0:return null;case 1:return e.value;case 2:return e.value;case 3:return e.value;case 4:{let t={type:1,value:""};return this.#e.push(t),""}case 7:{let t={type:2,value:[]};return this.#e.push(t),t.value}case 9:{let t={type:3,value:{}};return this.#e.push(t),t.value}default:throw new Error("Unexpected token type: "+o(e.type))}}};export{d as parse};
/**
 * @license
 * Copyright Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */
