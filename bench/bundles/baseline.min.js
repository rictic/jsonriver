var o=class{underlying;nextValue=null;constructor(e){this.underlying=e}[Symbol.asyncIterator](){return this}async next(){if(this.nextValue===null)return this.underlying.next();let e=this.nextValue;return this.nextValue=null,e}async peek(){return this.nextValue===null&&(this.nextValue=this.underlying.next()),this.nextValue}};async function*d(t){let e=new u(t);yield*l(e),await e.expectEndOfContent()}async function*l(t){for(;;){if(await t.skipWhitespace(),t.tryToTake("null")){yield{type:0,value:void 0};return}if(t.tryToTake("true")){yield{type:1,value:!0};return}if(t.tryToTake("false")){yield{type:1,value:!1};return}if(t.tryToTake('"')){yield*y(t);return}if(t.tryToTake("[")){if(yield{type:6,value:void 0},await t.skipWhitespace(),await t.peek(1)==="]"){await t.take(1),yield{type:7,value:void 0};return}for(;;){yield*l(t),await t.skipWhitespace();let r=await t.take(1);if(r==="]"){yield{type:7,value:void 0};return}else{if(r===",")continue;throw new Error("Unexpected character in the middle of array: "+r)}}}if(t.tryToTake("{")){if(yield{type:8,value:void 0},await t.skipWhitespace(),await t.peek(1)==="}"){await t.take(1),yield{type:9,value:void 0};return}for(;;){await t.skipWhitespace(),await t.matchPrefixOrDie('"'),yield*y(t),await t.skipWhitespace(),await t.matchPrefixOrDie(":"),yield*l(t),await t.skipWhitespace();let r=await t.take(1);if(r==="}"){yield{type:9,value:void 0};return}else{if(r===",")continue;throw new Error("Expected character in the middle of object: "+r)}}}if(t.testBuffer(/^[\-0-9]/)){yield*b(t);return}await t.expectMoreContent()}}function c(t){switch(t){case 0:return"null";case 1:return"boolean";case 2:return"number";case 3:return"string start";case 4:return"string middle";case 5:return"string end";case 6:return"array start";case 7:return"array end";case 8:return"object start";case 9:return"object end"}}async function*y(t){for(yield{type:3,value:void 0};;){let[e,r]=t.takeUntil(/["\\]/);if(e.length>0){if(/[\x00-\x1f]/.test(e))throw new Error("Unescaped control character in string");yield{type:4,value:e}}else if(!r){await t.expectMoreContent();continue}if(r){if(await t.take(1)==='"'){yield{type:5,value:void 0};return}let i=await t.take(1),n;switch(i){case"n":{n=`
`;break}case"r":{n="\r";break}case"t":{n="	";break}case"b":{n="\b";break}case"f":{n="\f";break}case"u":{let s=await t.take(4);n=JSON.parse(`"\\u${s}"`);break}case"\\":{n="\\";break}case"/":{n="/";break}case'"':{n='"';break}default:throw new Error("Bad escape in string")}yield{type:4,value:n}}}}async function*b(t){let e=await t.takeFullMatch(/^[\-+0123456789eE\.]+/);yield{type:2,value:JSON.parse(e)}}var u=class{buffer="";stream;constructor(e){this.stream=e[Symbol.asyncIterator]()}async expectMoreContent(){let{done:e,value:r}=await this.stream.next();if(e)throw new Error("Unexpected end of input");this.buffer+=r}async expectEndOfContent(){let e=()=>{if(this.buffer=this.buffer.trim(),this.buffer.length!==0)throw new Error(`Unexpected trailing content ${JSON.stringify(this.buffer)}`)};for(e();await this.tryToExpandBuffer();)e();e()}async tryToExpandBuffer(){let{done:e,value:r}=await this.stream.next();return e?!1:(this.buffer+=r,!0)}async skipWhitespace(){let e=/[^ \n\r\t]/;for(;;){let r=e.exec(this.buffer);if(r){this.buffer=this.buffer.slice(r.index);return}await this.expectMoreContent()}}async peek(e){for(;this.buffer.length<e;)await this.expectMoreContent();return this.buffer.slice(0,e)}testBuffer(e){return e.test(this.buffer)}tryToTake(e){return this.buffer.startsWith(e)?(this.buffer=this.buffer.slice(e.length),!0):!1}async take(e){for(;this.buffer.length<e;)await this.expectMoreContent();let r=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),r}async matchPrefixOrDie(e){for(;this.buffer.length<e.length;)await this.expectMoreContent();if(!this.buffer.startsWith(e))throw new Error("Expected "+e+" but got "+this.buffer.slice(0,e.length));this.buffer=this.buffer.slice(e.length)}takeUntil(e){let r=e.exec(this.buffer);if(r){let i=this.buffer.slice(0,r.index);return this.buffer=this.buffer.slice(r.index),[i,!0]}let a=this.buffer;return this.buffer="",[a,!1]}async takeFullMatch(e){for(;;){let r=this.buffer.match(e);if(!r){await this.expectMoreContent();continue}if(r[0]===this.buffer){if(await this.tryToExpandBuffer())continue;return this.buffer="",r[0]}return this.buffer=this.buffer.slice(r[0].length),r[0]}}};async function*p(t){let e=new o(d(t));yield*f(e);let r=await e.next();if(!r.done)throw new Error("Unexpected token: "+JSON.stringify(r.value))}async function*f(t){let e=await t.next();if(e.done)throw new Error("Unexpected end of input while expecting the start of a new value");switch(e.value.type){case 0:yield null;return;case 1:yield e.value.value;return;case 2:yield e.value.value;return;case 3:yield*h(t);return;case 6:yield*k(t);return;case 8:yield*w(t);return;default:throw new Error("Unexpected token type: "+e.value.type)}}async function*h(t){let e="";yield e;for await(let r of t)switch(r.type){case 4:e+=r.value,yield e;break;case 5:return;default:throw new Error(`Unexpected token type in the middle of string: ${c(r.type)}`)}}async function*k(t){let e=[];for(yield e;;){let r=await t.peek();if(r.done)throw new Error("Unexpected end of input in the middle of array");switch(r.value.type){case 7:await t.next();return;default:{let a=f(t),i=await a.next();if(i.done)throw new Error("Unexpected end of input in the middle of array");e.push(i.value),yield e;let n=e.length-1;for await(let s of a)e[n]=s,yield e}}}}async function*w(t){let e={};for(yield e;;){let r=await t.next();if(r.done)throw new Error("Unexpected end of input in the middle of object");if(r.value.type===9)return;if(r.value.type!==3)throw new Error(`Unexpected token type in the middle of object: ${c(r.value.type)}`);let a;for await(let i of h(t))a=i;if(a===void 0)throw new Error("Internal error: key should not be undefined");for await(let i of await f(t))e[a]=i,yield e;if(!(a in e))throw new Error("Internal error: key should be in result")}}export{p as parse};
/**
 * @license
 * Copyright Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */
